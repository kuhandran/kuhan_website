# CodeQL Advanced Security Analysis Workflow
# Scans for security vulnerabilities, code quality issues, and best practices
# Reports: GitHub Security tab, SARIF upload, and detailed artifacts

name: "CodeQL Advanced Security Analysis"

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]
  # Run security scan weekly on Sunday at 2 AM UTC
  schedule:
    - cron: '0 2 * * 0'
  # Allow manual trigger from Actions tab
  workflow_dispatch:

env:
  # Set node version
  NODE_VERSION: '18'

permissions:
  # Required for all workflows
  security-events: write
  contents: read
  actions: read
  # For pull requests
  pull-requests: write

jobs:
  # Code scanning analysis
  codeql-analysis:
    name: CodeQL Security Analysis (${{ matrix.language }})
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        include:
          # JavaScript/TypeScript analysis with extended security queries
          - language: javascript-typescript
            build-mode: none
            query-suite: 'security-extended' # Extended security queries

    steps:
      # Checkout repository with full history
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for better analysis

      # Setup Node.js environment
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      # Install dependencies (required for better analysis)
      - name: Install dependencies
        run: npm ci

      # Initialize CodeQL with extended security queries
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: ${{ matrix.language }}
          build-mode: ${{ matrix.build-mode }}
          # Use extended security + quality queries
          queries: security-and-quality,security-extended
          # Enable debug for detailed logging
          debug: true

      # Build project for better code analysis
      - name: Build project
        run: npm run build
        continue-on-error: true

      # Run CodeQL analysis with extended queries
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:${{ matrix.language }}"
          # Wait for processing to complete
          wait-for-processing: true
          # Upload results to GitHub Security tab
          upload: true

      # Note: CodeQL analyze action uploads SARIF directly to GitHub Security tab
      # For artifact storage, we would need to export the results first
      - name: Check for analysis results
        run: echo "CodeQL analysis complete. Results available in Security tab."

  # Additional security checks
  security-check:
    name: Security Checks
    runs-on: ubuntu-latest
    needs: codeql-analysis
    if: always()

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      # Dependency vulnerability check
      - name: Check Dependencies for Vulnerabilities
        run: npm audit --audit-level=moderate
        continue-on-error: true

      # Check for secrets in code
      - name: Run Trivy Vulnerability Scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'
        continue-on-error: true

      # Upload Trivy results
      - name: Upload Trivy Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-security-report
          path: trivy-results.sarif
          retention-days: 30

  # Quality gates check
  quality-gates:
    name: Quality Gates
    runs-on: ubuntu-latest
    needs: codeql-analysis
    if: always()

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # Type checking
      - name: TypeScript Type Check
        run: npx tsc --noEmit
        continue-on-error: true

      # Linting
      - name: Run ESLint
        run: npm run lint || true
        continue-on-error: true

      # Build check
      - name: Build Check
        run: npm run build
        continue-on-error: true

  # Report summary
  report-summary:
    name: Security Report Summary
    runs-on: ubuntu-latest
    needs: [codeql-analysis, security-check, quality-gates]
    if: always()

    steps:
      - name: Download Security Report
        uses: actions/download-artifact@v4
        with:
          name: trivy-security-report
        continue-on-error: true

      - name: Generate Report Summary
        run: |
          echo "## ðŸ”’ Security Scan Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### CodeQL Analysis" >> $GITHUB_STEP_SUMMARY
          echo "- Language: JavaScript/TypeScript" >> $GITHUB_STEP_SUMMARY
          echo "- Query Suite: security-and-quality, security-extended" >> $GITHUB_STEP_SUMMARY
          echo "- Results: Check 'Security' tab for detailed findings" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Scan Triggers" >> $GITHUB_STEP_SUMMARY
          echo "âœ… On every push to main/develop" >> $GITHUB_STEP_SUMMARY
          echo "âœ… On every pull request" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Weekly schedule (Sunday 2 AM UTC)" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Manual trigger from Actions tab" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Reports Available" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š [CodeQL Security Results](../../security/code-scanning)" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“‹ [Artifacts](../../actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ˆ [Scan Logs](../../actions/runs/${{ github.run_id }}/attempts/1)" >> $GITHUB_STEP_SUMMARY

