name: Sync Public Folder to portfolio-data-api

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'public/**'
      - '.github/workflows/sync-public-folder.yml'
  workflow_dispatch:  # Allow manual trigger

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout kuhan_website
        uses: actions/checkout@v3
        with:
          repository: kuhandran/kuhan_website
          token: ${{ secrets.GITHUB_TOKEN }}
          path: kuhan_website

      - name: Checkout portfolio-data-api
        uses: actions/checkout@v3
        with:
          repository: kuhandran/portfolio-data-api
          token: ${{ secrets.PAT_TOKEN }}  # Use PAT for private repo access
          path: portfolio-data-api

      - name: Sync public folder
        run: |
          echo "Syncing public folder from kuhan_website to portfolio-data-api..."
          
          # Create public folder in api repo if it doesn't exist
          mkdir -p portfolio-data-api/public
          
          # Copy public folder contents
          rsync -av --delete \
            --exclude '.gitkeep' \
            --exclude 'node_modules' \
            --exclude '.next' \
            kuhan_website/public/ portfolio-data-api/public/
          
          echo "âœ“ Sync completed successfully"

      - name: Commit and push changes
        working-directory: portfolio-data-api
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Check if there are changes
          if git diff --quiet && git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          
          git add public/
          git commit -m "Sync public folder from kuhan_website [automated]" || true
          git push origin main || git push origin master || echo "Failed to push, checking branch..."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
